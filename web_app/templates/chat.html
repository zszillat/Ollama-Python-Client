{% extends "base.html" %}

{% block title %}{% endblock %}
{% block css %}
<link rel="stylesheet" href="static/chat.css">
{% endblock %}

<!-- TOPBAR -->
{% block topbar %}
    <!-- <div id="open" class="custom-dropdown-container">
        <div id="selectBox">
            <p id="openSelect">{{ default_preset }}</p>
        </div>
        <div id="optionBox">
            <div class="buffer"></div>
            {% for preset in presets %}
            <p>{{ preset.name }}</p>
            {% endfor %}
            <p>test</p>
            <p>test but kinda longer</p>
            <p>test</p>
            <div class="buffer"></div>
        </div>
    </div>
    <div id="closed" class="custom-dropdown-container">
        <div id="selectBox">
            <p id="closedSelect">{{ default_preset }}</p>
        </div>
    </div> -->
    <select id="presetSelect" name="preset">
        {% for preset in presets %}
          <option 
            value="{{ preset.name }}" 
            {% if preset.name == default_preset %}selected{% endif %}
          >
            {{ preset.name }}
          </option>
        {% endfor %}
      </select>
      
      
{% endblock %}



<!-- MAIN -->
{% block content %}

    <div id="chat">
        {% for message in messages %}
        <div class="{{ message.role }}">
            <strong>{{ message.role.capitalize() }}:</strong> 
            <div class="message-content" data-content="{{ message.content | e }}"></div>
        </div>                               
        {% endfor %}
    </div>

    <form action="/chat" method="post" id="chat-form">
        <input type="text" name="user_input" placeholder="Type your message..." required autofocus>
        <button type="submit">Send</button>
    </form>
{% endblock %}

{% block scripts %}
<script>
    const chatDiv = document.getElementById("chat");
    chatDiv.scrollTop = chatDiv.scrollHeight;

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".message-content").forEach(div => {
            const raw = div.getAttribute("data-content");
            div.innerHTML = marked.parse(raw);
        });

        Prism.highlightAll();

        // dropdown logic
        const presetSelect = document.getElementById('presetSelect')
        const open = document.getElementById('open')
        const openSelect = document.getElementById('openSelect')
        const closed = document.getElementById('closed')
        const closedSelect = document.getElementById('closedSelect')
        const optionBox = document.getElementById('optionBox');
        const pNodeList = optionBox.querySelectorAll(':scope > p');
        const pArray = Array.from(pNodeList);

        closedSelect.addEventListener('click', () => {
            closed.style.display = "none";
            open.style.display = "flex";
        })

        openSelect.addEventListener('click', () => {
            open.style.display = "none";
            closed.style.display = "flex";
        })

        pArray.forEach((p, idx) => {
            p.addEventListener('click', () => {
                presetSelect.value = p.textContent
                openSelect.textContent = p.textContent
                closedSelect.textContent = p.textContent
                open.style.display = "none"
                closed.style.display = "flex"
            });
        });

    });
</script>
{% endblock %}
